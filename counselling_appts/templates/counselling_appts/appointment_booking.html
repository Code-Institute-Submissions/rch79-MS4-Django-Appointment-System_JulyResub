{% extends "base.html" %}
{% load static %}

{% block extra_title %}
  - Appointment Booking
{% endblock %}

{% block extra_css %}
  {{ block.super }}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="{% static 'counselling_appts/css/appointment-picker.css' %}">
{% endblock %}

{% block extra_js%}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="{% static 'counselling_appts/js/appointment-picker.min.js' %}"></script>
{% endblock %}

{% block content %}
  <form action>
    <label for="flatpickr">Please select the appointment date:</label><br>
    <input class="flatpickr flatpickr-input active" type="text" placeholder="Select Date.." readonly="readonly" id="flatpickr">
  </form>
  <p>{{ request.user }}</p>
  <p>Dates dict: {{ dates_dict }}</p>
  <p>Blocked DAtes: {{ blocked_dates }}</p>
  <p>Test_text: {{ test_text }}</p>
  <p>Available time slots: {{ time_slots }}</p>

  <div id="debug"></div>
  <div id="time-picker"></div>
{% endblock %}

{% block postload_js %}
{{ block.super }}
{{ blocked_dates|json_script:"blocked_dates" }}
{{ dates_dict|json_script:"dates_dict" }}
  <script type="text/javascript" src="{% static 'counselling_appts/js/flatpickr_date_picker.js' %}"></script>

  <script type="text/javascript">
    fp.config.onChange.push(function() {
      const date_dict = JSON.parse(document.getElementById('dates_dict').textContent);
      console.log(fp.selectedDates);
      d = fp.selectedDates[0];
      var year = d.getFullYear();
      var month = (d.getMonth() + 1).toString().padStart(2, '0');
      var day = d.getDate().toString().padStart(2, '0');
      var datePicked = [year, month, day].join('-');

      for (var [key, value] of Object.entries(date_dict)) {
        console.log(`key: ${key} value: ${value}`);
        console.log(`key: ${key} new value: ${value}`);
      }

      var blocked_slots = date_dict[datePicked]
      console.log(`blocked_slots: ${date_dict[datePicked]}`)

      $( "#debug" ).append( `<p> blocked slots: ${blocked_slots} </p>` );
      $( "#time-picker" ).append(`
        <p id="time-picker-inner">
          <label for="time-ev">Time</label>
          <input id="time-ev" type="text" value="18:00" placeholder="h:mm" aria-live="assertive" aria-label="Use up or down arrow keys to change time">
          <span id="action-ev-out">closed</span>
          <span id="time-ev-out">change the time</span>
        </p>
      `);

      var disabled_timeslot = [blocked_slots[0]]
      ap = new AppointmentPicker(document.getElementById('time-ev'), {
	      interval: 60,
	      minTime: 09,
	      maxTime: 18,
	      disabled: [blocked_slots[0]] 
      });
      // Add event listener on input field
      document.getElementById('time-ev').addEventListener('change.appo.picker', function (e) {
	      document.getElementById('time-ev-out').innerHTML = JSON.stringify(e.time) + ', ' + JSON.stringify(e.displayTime);
      }, false);
      document.getElementById('time-ev').addEventListener('close.appo.picker', function (e) {
        document.getElementById('action-ev-out').innerHTML = 'closed';
        document.getElementById('time-picker-inner').remove();
      }, false);
      document.getElementById('time-ev').addEventListener('open.appo.picker', function (e) {
        document.getElementById('action-ev-out').innerHTML = 'open';
      }, false); 
     });
  </script>
{% endblock %}





